generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum City {
  MINSK
  BREST
  GRODNO
}

enum Hand {
  RIGHT
  LEFT
}

enum Position {
  DERECHA
  REVES
  BOTH
}

enum Experience {
  BEGINNER
  LESS_YEAR
  ONE_THREE
  THREE_PLUS
}

enum TimeSlot {
  MORNING
  AFTERNOON
  EVENING
  ANY
}

enum MatchType {
  RATED
  FRIENDLY
}

enum MatchStatus {
  RECRUITING
  FULL
  IN_PROGRESS
  PENDING_SCORE
  PENDING_CONFIRMATION
  COMPLETED
  CANCELLED
}

enum TournamentStatus {
  UPCOMING
  REGISTRATION
  IN_PROGRESS
  COMPLETED
}

// === Coach Panel enums ===

enum CoachSubscriptionTier {
  FREE
  PAID
}

enum TrainingSessionType {
  INDIVIDUAL
  GROUP
}

enum TrainingSessionStatus {
  OPEN
  FULL
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  NO_SHOW
}

enum PaymentType {
  SINGLE
  PACKAGE
}

enum PaymentStatus {
  AWAITING
  PAID
  REFUNDED
}

model User {
  id              Int       @id @default(autoincrement())
  telegramId      BigInt    @unique
  username        String?
  firstName       String
  lastName        String?
  photoUrl        String?
  city            City
  hand            Hand?
  position        Position?
  experience      Experience?
  preferredTime   TimeSlot  @default(ANY)
  rating          Int       @default(1500)
  ratingSource    String?
  matchesPlayed   Int       @default(0)
  wins            Int       @default(0)
  losses          Int       @default(0)
  winStreak       Int       @default(0)
  maxWinStreak    Int       @default(0)
  ratingEditUsed  Boolean   @default(false)
  isVisible       Boolean   @default(true)
  reminderMinutes Int       @default(120)
  xp              Int       @default(0)
  onboarded       Boolean   @default(false)
  isAdmin         Boolean   @default(false)
  isVip           Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Coach fields
  isCoach               Boolean                @default(false)
  coachSubscriptionTier CoachSubscriptionTier?
  coachSubscriptionEnd  DateTime?
  coachBio              String?
  coachExperience       String?
  coachCertificates     String?
  coachHourlyRate       Int?
  coachSpecialization   String?
  coachRating           Float?
  coachReviewCount      Int                    @default(0)

  matchPlayers    MatchPlayer[]
  ratingHistory   RatingHistory[]
  createdMatches  Match[]              @relation("MatchCreator")
  scoreConfirms   ScoreConfirmation[]
  achievements    UserAchievement[]
  matchComments   MatchComment[]
  tournamentRegs1 TournamentRegistration[] @relation("TournamentPlayer1")
  tournamentRegs2 TournamentRegistration[] @relation("TournamentPlayer2")

  // Coach relations
  coachStudents         CoachStudent[]         @relation("CoachRelation")
  studentOfCoaches      CoachStudent[]         @relation("StudentRelation")
  coachSessions         TrainingSession[]      @relation("CoachSessions")
  sessionBookings       SessionBooking[]
  coachNotesWritten     CoachNote[]            @relation("CoachNoteAuthor")
  coachNotesAboutMe     CoachNote[]            @relation("CoachNoteSubject")
  coachPaymentsReceived CoachPayment[]         @relation("PaymentCoach")
  coachPaymentsSent     CoachPayment[]         @relation("PaymentStudent")
  coachPackagesSold     CoachPackage[]         @relation("PackageCoach")
  coachPackagesBought   CoachPackage[]         @relation("PackageStudent")
  coachReviewsReceived  CoachReview[]          @relation("ReviewSubject")
  coachReviewsGiven     CoachReview[]          @relation("ReviewAuthor")
}

model Venue {
  id          Int     @id @default(autoincrement())
  name        String
  address     String
  city        City
  courts      Int     @default(1)
  phone       String?
  website     String?
  matches          Match[]
  tournaments      Tournament[]
  trainingSessions TrainingSession[]
}

model Match {
  id            Int         @id @default(autoincrement())
  creatorId     Int
  creator       User        @relation("MatchCreator", fields: [creatorId], references: [id])
  venueId       Int
  venue         Venue       @relation(fields: [venueId], references: [id])
  date          DateTime
  durationMin   Int
  levelMin      Float
  levelMax      Float
  courtBooked   Boolean     @default(false)
  courtNumber   Int?
  matchType     MatchType   @default(RATED)
  status        MatchStatus @default(RECRUITING)
  notes            String?
  tournamentId     Int?
  scoreSubmittedAt DateTime?
  scoreSubmitterId Int?
  createdAt        DateTime    @default(now())

  players       MatchPlayer[]
  sets          MatchSet[]
  confirmations ScoreConfirmation[]
  comments      MatchComment[]
}

model MatchPlayer {
  id           Int      @id @default(autoincrement())
  matchId      Int
  match        Match    @relation(fields: [matchId], references: [id])
  userId       Int
  user         User     @relation(fields: [userId], references: [id])
  team         Int?
  status       String   @default("APPROVED")
  reminderSent Boolean  @default(false)

  @@unique([matchId, userId])
}

model MatchSet {
  id             Int   @id @default(autoincrement())
  matchId        Int
  match          Match @relation(fields: [matchId], references: [id])
  setNumber      Int
  team1Score     Int
  team2Score     Int
  team1Tiebreak  Int?
  team2Tiebreak  Int?

  @@unique([matchId, setNumber])
}

model ScoreConfirmation {
  id        Int      @id @default(autoincrement())
  matchId   Int
  match     Match    @relation(fields: [matchId], references: [id])
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  confirmed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([matchId, userId])
}

model RatingHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  oldRating Int
  newRating Int
  change    Int
  reason    String
  matchId   Int?
  note      String?
  createdAt DateTime @default(now())
}

model Achievement {
  id          String  @id
  name        String
  description String
  icon        String
  category    String
  xp          Int
  condition   Json
  users       UserAchievement[]
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        Int
  user          User        @relation(fields: [userId], references: [id])
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  unlockedAt    DateTime    @default(now())

  @@unique([userId, achievementId])
}

model MatchComment {
  id        Int      @id @default(autoincrement())
  matchId   Int
  match     Match    @relation(fields: [matchId], references: [id])
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  text      String
  createdAt DateTime @default(now())
}

model Tournament {
  id               Int              @id @default(autoincrement())
  name             String
  description      String
  date             DateTime
  endDate          DateTime?
  city             City
  venueId          Int
  venue            Venue            @relation(fields: [venueId], references: [id])
  format           String
  levelMin         Float
  levelMax         Float
  maxTeams         Int
  price            String?
  ratingMultiplier Float            @default(1.0)
  status           TournamentStatus @default(REGISTRATION)
  prizes           Json?
  createdAt        DateTime         @default(now())

  registrations TournamentRegistration[]
}

model TournamentRegistration {
  id           Int        @id @default(autoincrement())
  tournamentId Int
  tournament   Tournament @relation(fields: [tournamentId], references: [id])
  player1Id    Int
  player1      User       @relation("TournamentPlayer1", fields: [player1Id], references: [id])
  player2Id    Int
  player2      User       @relation("TournamentPlayer2", fields: [player2Id], references: [id])
  createdAt    DateTime   @default(now())

  @@unique([tournamentId, player1Id])
}

model DailyStats {
  id               Int      @id @default(autoincrement())
  date             DateTime @unique @db.Date
  totalUsers       Int      @default(0)
  newUsers         Int      @default(0)
  totalMatches     Int      @default(0)
  newMatches       Int      @default(0)
  completedMatches Int      @default(0)
  activeUsers      Int      @default(0)
  topRatingChange  Int      @default(0)
  topRatingUserId  Int?
  cityCounts       Json     @default("{}")
  createdAt        DateTime @default(now())
}

// === Coach Panel models ===

model CoachStudent {
  id        Int      @id @default(autoincrement())
  coachId   Int
  coach     User     @relation("CoachRelation", fields: [coachId], references: [id])
  studentId Int
  student   User     @relation("StudentRelation", fields: [studentId], references: [id])
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([coachId, studentId])
}

model TrainingSession {
  id          Int                   @id @default(autoincrement())
  coachId     Int
  coach       User                  @relation("CoachSessions", fields: [coachId], references: [id])
  venueId     Int?
  venue       Venue?                @relation(fields: [venueId], references: [id])
  type        TrainingSessionType
  date        DateTime
  durationMin Int                   @default(60)
  maxStudents Int                   @default(1)
  price       Int?
  notes       String?
  status      TrainingSessionStatus @default(OPEN)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  bookings    SessionBooking[]
}

model SessionBooking {
  id           Int             @id @default(autoincrement())
  sessionId    Int
  session      TrainingSession @relation(fields: [sessionId], references: [id])
  studentId    Int
  student      User            @relation(fields: [studentId], references: [id])
  status       BookingStatus   @default(PENDING)
  reminderSent Boolean         @default(false)
  createdAt    DateTime        @default(now())

  @@unique([sessionId, studentId])
}

model CoachNote {
  id         Int      @id @default(autoincrement())
  coachId    Int
  coach      User     @relation("CoachNoteAuthor", fields: [coachId], references: [id])
  studentId  Int
  student    User     @relation("CoachNoteSubject", fields: [studentId], references: [id])
  text       String
  isHomework Boolean  @default(false)
  createdAt  DateTime @default(now())
}

model CoachPayment {
  id        Int           @id @default(autoincrement())
  coachId   Int
  coach     User          @relation("PaymentCoach", fields: [coachId], references: [id])
  studentId Int
  student   User          @relation("PaymentStudent", fields: [studentId], references: [id])
  amount    Int
  type      PaymentType   @default(SINGLE)
  packageId Int?
  package   CoachPackage? @relation(fields: [packageId], references: [id])
  status    PaymentStatus @default(AWAITING)
  note      String?
  paidAt    DateTime?
  createdAt DateTime      @default(now())
}

model CoachPackage {
  id            Int      @id @default(autoincrement())
  coachId       Int
  coach         User     @relation("PackageCoach", fields: [coachId], references: [id])
  studentId     Int
  student       User     @relation("PackageStudent", fields: [studentId], references: [id])
  totalSessions Int
  usedSessions  Int      @default(0)
  priceTotal    Int
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())

  payments      CoachPayment[]
}

model CoachReview {
  id        Int      @id @default(autoincrement())
  coachId   Int
  coach     User     @relation("ReviewSubject", fields: [coachId], references: [id])
  authorId  Int
  author    User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  rating    Int
  text      String?
  createdAt DateTime @default(now())

  @@unique([coachId, authorId])
}
